rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========== users ==========
    match /users/{uid} {
      // เจ้าของอ่าน/เขียนโปรไฟล์ตัวเองได้เท่านั้น
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if request.auth != null && request.auth.uid == uid;
    }

    // helper: ตรวจว่าเป็นเจ้าของร้าน
    function isOwner(restId) {
      return request.auth != null
        && get(/databases/$(database)/documents/restaurants/$(restId)).data.owner_id
           == request.auth.uid;
    }

    // ========== restaurants ==========
    match /restaurants/{restId} {
      // ใคร ๆ ก็อ่านรายละเอียดร้านได้
      allow read: if true;

      // สร้างร้าน: owner_id ในเอกสารต้องตรงกับ uid
      allow create: if request.auth != null
                    && request.resource.data.owner_id == request.auth.uid;

      // แก้ไข/ลบ: ต้องเป็นเจ้าของร้าน
      allow update, delete: if isOwner(restId);

      // ----- subcollections: menus -----
      match /menus/{menuId} {
        allow read: if true;
        allow create, update, delete: if isOwner(restId);
      }

      // (ถ้ามีตาราง/คิว ฯลฯ ก็ทำคล้าย ๆ กัน)
      match /tables/{tableId} {
        allow read: if true;
        allow create, update, delete: if isOwner(restId);
      }
    }

    // ปริยาย: ปฏิเสธทั้งหมด (ถ้าไม่ได้ match ข้างบน)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
